# 리액트 쿼리 시작하기

## 1. 쿼리 클라이언트 생성

- 쿼리 클라이언트(QueryClient)는 데이터를 관리하고 캐싱하는 역할을 한다.

## 2. QueryProvider 적용

- QueryProvider는 자식 컴포넌트들에게 쿼리 클라이언트와 캐시 설정을 제공하는 역할을 한다.

## 3. useQuery 호출

- `useQuery` 훅은 서버에 데이터를 요청하고 비동기적으로 데이터를 처리하는 역할을 한다.

# isFetching과 isLoading

## 1. isFetching

- `isFetching`은 비동기 쿼리가 아직 완료되지 않았음을 나타낸다. 예를 들어, 데이터를 가져오는 중이지만 아직 완료되지 않은 상태이다. 다른 종류의 데이터를 가져오는 작업이라면 이 상태를 통해 로딩 중임을 알 수 있다.

> ## 쿼리란?

- 쿼리는 서버로부터 데이터를 요청하는 작업을 의미한다. `useQuery` 훅을 사용하여 API로 데이터를 요청하고, 이때 요청하는 작업을 쿼리라고 부른다.

## 2. isLoading

- `isLoading`은 `isFetching`의 하위 집합으로, 쿼리 함수가 아직 완료되지 않은 상태이고 캐시된 데이터도 없을 때를 의미한다. 이 경우에는 이전에 해당 쿼리를 실행한 적이 없어서 새로 데이터를 가져오고 있는 중임을 나타낸다.

# staleTime과 gcTime

## 1. staleTime

- `staleTime`은 데이터를 다시 가져와야 할 시점을 결정한다.

- 기본값은 0ms로 설정되어 있으며, 이는 데이터를 가져온 직후 바로 stale로 간주되어 즉시 서버에서 다시 데이터를 가져오려고 시도한다.

> ## Stale Data란?

- 데이터가 오래됐다는 것은 유효기간이 만료되어 새로 데이터를 가져올 준비가 되었다는 뜻이다. 이때 데이터는 여전히 캐시에 남아 있지만 stale 상태로 표시되며 다시 검증이 필요하게 된다. 데이터의 prefetch는 stale 상태일 때만 트리거되는데 예를 들어 컴포넌트가 다시 마운트되거나 브라우저 창이 리포커싱될 때 발생한다. `staleTime`은 데이터의 최대 수명으로, 서버에서 최신 데이터를 가져오기 전에 데이터를 캐시에서 얼마나 오랫동안 사용할지를 결정한다.

## 2. gcTime

- `gcTime`은 캐시된 데이터를 얼마나 오랫동안 유지할지 결정한다. 데이터와 관련된 활성 `useQuery`가 없고, 현재 페이지에서 데이터가 표시되지 않으면 "cold storage" 상태로 전환된다. 이때 데이터는 사용되지 않지만 캐시에 남아 있으며, `gcTime`이 지나면 캐시에서 삭제된다.

- 기본값은 5분으로, 데이터가 페이지에 표시된 후부터 시간이 측정된다. 즉, 데이터가 페이지에 표시될 때는 `gcTime`이 진행되지 않으며, 데이터가 더 이상 사용되지 않으면 시간이 진행된다.

- gcTime이 지나면 데이터는 garbage collection 처리되어 Tanstack Query에서 더 이상 사용할 수 없다.

## 3. 케이스 비교

### 1. 데이터가 fresh이고, staleTime도 남아 있으며, 캐시에도 있고, gcTime도 지나지 않은 경우 (Fresh and in cache)

- 캐시된 데이터를 그대로 사용하며, refetch는 트리거되지 않는다. 왜냐하면 데이터가 fresh 상태이므로 추가적인 요청 없이 캐시된 데이터를 사용할 수 있기 때문이다.

### 2. 데이터가 stale이고 캐시에 있는 경우 (Stale and in cache)

- refetch 트리거가 발생하면 서버에서 최신 데이터를 가져오기 전에(데이터를 가져오는 동안) 캐시된 데이터를 표시한다.

### 3. 데이터가 캐시에 없고, gcTime이 지나 데이터가 삭제된 경우 (Not in cache)

- 데이터가 삭제되어 캐시에 없으면, 새로 가져오는 동안 표시할 데이터가 없다. 서버에서 데이터를 가져올 때까지 쿼리는 빈 데이터를 반환하며, 데이터가 준비되면 다시 표시된다.

- 데이터가 캐시에 있을 경우, `useQuery`는 조건에 맞는 캐시된 데이터를 반환하고, 필요한 경우 refetch가 발생한다. 하지만 캐시에 데이터가 없으면 서버에서 데이터를 가져올 때까지 표시할 데이터가 없다는 점을 유의해야 한다.
